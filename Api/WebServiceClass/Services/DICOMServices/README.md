# DICOM SCP 服务

这是一个完整的DICOM SCP（Service Class Provider）服务实现，用于接收和处理DICOM文件。

## 功能特性

### 核心功能
- **DICOM文件接收**: 支持C-STORE请求，接收DICOM文件
- **连接管理**: 支持C-ECHO请求，验证连接状态
- **文件验证**: 自动验证DICOM文件完整性和必要标签
- **异步处理**: 完整的异步方法实现
- **错误处理**: 完善的异常处理和错误恢复机制

### 监控和管理
- **服务状态监控**: 实时监控服务运行状态
- **连接管理**: 跟踪活动连接和连接历史
- **文件统计**: 记录接收文件的数量、大小等信息
- **日志记录**: 详细的日志记录和审计跟踪

### 配置管理
- **灵活配置**: 通过appsettings.json进行配置
- **安全控制**: 支持AE标题验证和访问控制
- **文件管理**: 可配置文件大小限制和存储位置

## 配置说明

在`appsettings.json`中配置DICOM SCP服务：

```json
{
  "SCPService": {
    "Enabled": true,                    // 是否启用服务
    "AETitle": "HOSPITAL_SCP_AE",      // AE标题
    "Port": 104,                       // 监听端口
    "IPAddress": "0.0.0.0",           // 监听IP地址
    "OutputDirectory": "ReceivedDICOMs", // 文件保存目录
    "MaxFileSize": 104857600,         // 最大文件大小（字节）
    "AllowedCallingAEs": [],          // 允许的调用方AE列表
    "LogLevel": "Information",         // 日志级别
    "MonitorInterval": 30              // 文件监控间隔（秒）
  }
}
```

## 服务组件

### 1. DicomSCPServices
主要的DICOM SCP服务实现，继承自`IHostedService`，支持：
- 服务启动和停止
- 配置管理
- 状态跟踪

### 2. DicomScp
DICOM服务处理类，实现：
- C-STORE请求处理
- C-ECHO请求处理
- 关联管理
- 文件验证和保存

### 3. DicomFileMonitorService
后台文件监控服务，提供：
- 文件后处理
- 文件信息提取
- 定期监控

### 4. DicomServiceStatus
服务状态管理，提供：
- 连接跟踪
- 文件统计
- 服务监控

### 5. DicomController
REST API控制器，提供：
- 服务状态查询
- 连接管理
- 文件列表
- 健康检查

## API接口

### 获取服务状态
```
GET /api/dicom/status
```

### 获取活动连接
```
GET /api/dicom/connections
```

### 获取最近文件
```
GET /api/dicom/recent-files?count=10
```

### 重置统计信息
```
POST /api/dicom/reset-statistics
```

### 健康检查
```
GET /api/dicom/health
```

## 使用方法

### 1. 启动服务
服务会在应用程序启动时自动启动（如果配置为启用）。

### 2. 发送DICOM文件
使用DICOM客户端连接到服务：
- 主机: 配置的IP地址
- 端口: 配置的端口（默认104）
- AE标题: 配置的AE标题

### 3. 监控服务
通过API接口监控服务状态和接收的文件。

## 日志记录

服务会记录以下信息：
- 连接建立和断开
- 文件接收成功/失败
- 错误和异常
- 服务状态变化

日志文件保存在`LogInfos`目录下，按日期和模块分类。

## 安全考虑

1. **AE标题验证**: 可以配置允许的调用方AE列表
2. **文件大小限制**: 防止接收过大的文件
3. **连接管理**: 跟踪和管理活动连接
4. **错误处理**: 防止服务因异常而崩溃

## 扩展功能

可以根据需要扩展以下功能：
- 数据库集成，持久化存储文件信息
- 文件自动归档和清理
- 更复杂的AE验证逻辑
- 文件格式转换
- 与其他系统的集成

## 故障排除

### 常见问题

1. **服务无法启动**
   - 检查端口是否被占用
   - 验证配置文件格式
   - 查看日志文件

2. **无法接收文件**
   - 检查网络连接
   - 验证AE标题配置
   - 确认防火墙设置

3. **文件保存失败**
   - 检查磁盘空间
   - 验证目录权限
   - 查看文件大小限制

### 日志分析
查看`LogInfos`目录下的日志文件，重点关注：
- ERROR级别的日志
- 连接和文件接收相关的日志
- 服务启动和停止的日志
